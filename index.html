<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ğŸ”§ Agenda de Consultas de PeÃ§as</title>

  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json">

  <!-- Seu CSS aqui -->
  <link rel="stylesheet" href="styles.css">

  <!-- PapaParse (CSV â†’ JSON) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>ğŸ”§ Agenda de Consultas de PeÃ§as</h1>

    <!-- Status Online / Cache -->
    <div id="statusCache" class="status">Carregando status...</div>

    <!-- BotÃ£o atualizar forÃ§ando recarga do CSV -->
    <button id="btnAtualizar">ğŸ”„ Atualizar Dados</button>

    <!-- EstatÃ­sticas -->
    <div id="estatisticas"></div>

    <!-- Busca -->
    <div class="search-bar">
      <input type="text" id="inputBusca" placeholder="Digite o cÃ³digo da peÃ§a">
      <button id="btnBuscar">ğŸ” Buscar</button>
      <button id="btnLimpar">âŒ Limpar</button>
    </div>

    <!-- Resultados -->
    <div id="resultados"></div>
  </div>

  <script>
    let todasPecas = [];

    // â€”â€”â€” Cache em localStorage â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    function salvarNoCache(data) {
      localStorage.setItem('pecasCache', JSON.stringify(data));
      localStorage.setItem('pecasCacheTime', Date.now());
    }
    function carregarDoCache() {
      const s = localStorage.getItem('pecasCache');
      try { return s ? JSON.parse(s) : null; }
      catch { return null; }
    }

    // â€”â€”â€” UI de status e estatÃ­sticas â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    function atualizarStatusCache() {
      const online = navigator.onLine;
      const time = localStorage.getItem('pecasCacheTime');
      const ago = time ? Math.floor((Date.now() - Number(time)) / 60000) : null;
      document.getElementById('statusCache').textContent =
        online
          ? `âœ… Online â€“ cache local (${ago} min atrÃ¡s)`
          : `âŒ Offline â€“ cache local (${ago} min atrÃ¡s)`;
    }
    function atualizarEstatisticas() {
      const total = todasPecas.length;
      const comImg = todasPecas.filter(p=>p.imagem).length;
      const semImg = total - comImg;
      document.getElementById('estatisticas').innerHTML =
        `<p>ğŸ“Š EstatÃ­sticas: ${total} peÃ§as cadastradas | ${comImg} com imagens | ${semImg} sem imagens</p>`;
    }

    // â€”â€”â€” ExibiÃ§Ã£o de resultados â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    function exibirResultados(lista) {
      const cont = document.getElementById('resultados');
      cont.innerHTML = '';
      if (lista.length === 0) {
        cont.innerHTML = '<p>Nenhum resultado encontrado.</p>';
        return;
      }
      lista.forEach(p => {
        const card = document.createElement('div');
        card.className = 'card';

        const img = document.createElement('img');
        img.src = `images/pecas/${p.imagem}`;
        img.alt = p.codigo;
        img.onerror = ()=> img.src = 'images/placeholder.png';
        card.append(img);

        const info = document.createElement('div');
        info.innerHTML = `
          <span class="label">${p.codigo}</span>
          <p><strong>DescriÃ§Ã£o:</strong> ${p.descricao}</p>
        `;
        card.append(info);
        cont.append(card);
      });
    }

    // â€”â€”â€” Busca por cÃ³digo â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    function buscarCodigo() {
      const termo = document.getElementById('inputBusca').value.trim().toUpperCase();
      if (!termo) { exibirResultados(todasPecas); return; }
      const res = todasPecas.filter(p => p.codigo.includes(termo));
      exibirResultados(res);
    }

    // â€”â€”â€” Carregamento do CSV + PapaParse + Cache â€”â€”â€”â€”â€”â€”â€”â€”â€”
    async function carregarDados(force = false) {
      // 1) usa cache local se nÃ£o for forÃ§ado
      if (!force) {
        const cache = carregarDoCache();
        if (cache) {
          todasPecas = cache;
          atualizarEstatisticas();
          atualizarStatusCache();
          return;
        }
      }

      // 2) busca CSV no disco (jÃ¡ cacheado pelo SW)
      try {
        const resp = await fetch('data/Tabela_de_Pecas.csv');
        if (!resp.ok) throw new Error('Falha ao carregar CSV');
        const csv = await resp.text();

        const parsed = Papa.parse(csv, { header: true, skipEmptyLines: true });
        todasPecas = parsed.data.map(r => ({
          codigo: (r['OCORRÃŠNCIA'] || r['ocorrencia'] || '').trim(),
          descricao: (r['DESCRIÃ‡ÃƒO']  || r['descricao']  || '').trim(),
          imagem:  `${(r['OCORRÃŠNCIA'] || r['ocorrencia']).trim()}.png`
        }));

        salvarNoCache(todasPecas);
        atualizarEstatisticas();
        atualizarStatusCache();

      } catch (e) {
        console.error(e);
        const cache = carregarDoCache();
        if (cache) {
          todasPecas = cache;
          atualizarEstatisticas();
          atualizarStatusCache();
        } else {
          document.getElementById('estatisticas').innerHTML =
            `<p>âš ï¸ ${e.message}</p>`;
          atualizarStatusCache();
        }
      }
    }

    // â€”â€”â€” Event Listeners â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    document.getElementById('btnAtualizar').addEventListener('click', ()=>carregarDados(true));
    document.getElementById('btnBuscar')   .addEventListener('click', buscarCodigo);
    document.getElementById('btnLimpar')   .addEventListener('click', () => {
      document.getElementById('inputBusca').value = '';
      exibirResultados(todasPecas);
    });
    window.addEventListener('online',  atualizarStatusCache);
    window.addEventListener('offline', atualizarStatusCache);

    // â€”â€”â€” Startup â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    (async()=>{
      await carregarDados();
      exibirResultados(todasPecas);
    })();

    // â€”â€”â€” Registro do Service Worker â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker
        .register('sw.js')
        .then(()=> console.log('SW registrado ğŸ”¥'))
        .catch(err=> console.error('SW falhou:', err));
    }
  </script>
</body>
</html>
